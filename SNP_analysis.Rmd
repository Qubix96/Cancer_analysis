---
title: "SNP_analysis"
author: "Jakub Kubi≈õ"
date: "22 08 2020"
output: html_document
---

###Data preparing
# Requirements 1
```{r echo=TRUE}
library(tidyverse)
```

##Data joining
#Breast and ovarian data

```{r}

breast <- read.csv("DataBreast/simple_somatic_mutation.open.tsv", sep = '\t', header = TRUE)
breast <- breast %>% 
  select(icgc_mutation_id, 
         icgc_donor_id, 
         chromosome, 
         chromosome_start, 
         chromosome_end,
         reference_genome_allele,
         mutated_from_allele,
         mutated_to_allele,) %>% 
  distinct()


ovary <- read.csv("DataOvary/simple_somatic_mutation.open.tsv", sep = '\t', header = TRUE)
ovary <- ovary %>% 
  select(icgc_mutation_id, 
         icgc_donor_id, 
         chromosome, 
         chromosome_start, 
         chromosome_end,
         reference_genome_allele,
         mutated_from_allele,
         mutated_to_allele) %>% 
  distinct()


ovary$cancer_type <- "Ovarian cancer"
breast$cancer_type <- "Breast cancer"

patient <- breast %>% 
  inner_join(ovary, by = 'icgc_mutation_id') %>% 
  distinct()

patient <- patient %>% 
  select(icgc_mutation_id) %>% 
  distinct()

mutation <- rbind(breast, ovary)

mutation <- mutation %>% 
  filter(icgc_mutation_id %in% patient$icgc_mutation_id)
         

remove(breast, ovary)


```

#Donor data

```{r}

donor_breast <- read.csv("DataBreast/donor.tsv", sep = '\t', header = TRUE)

donor_breast <- donor_breast %>% 
  select(icgc_donor_id,
         donor_vital_status, 
         disease_status_last_followup,
         donor_age_at_diagnosis,
         donor_age_at_last_followup)

donor_breast$cancer_type <- "Breast cancer"

donor_ovary <- read.csv("DataOvary/donor.tsv", sep = '\t', header = TRUE)

donor_ovary <- donor_ovary %>% 
  select(icgc_donor_id,
         donor_vital_status, 
         disease_status_last_followup,
         donor_age_at_diagnosis,
         donor_age_at_last_followup)

donor_ovary$cancer_type <- 'Ovarian cancer'
```

#Join donor - mutation

```{r}
#Join donor - mutation

mutation_breast <- mutation %>% 
  left_join(donor_breast, by = c('icgc_donor_id', 'cancer_type')) 

mutation_ovary <- mutation %>% 
  left_join(donor_ovary, by = c('icgc_donor_id', 'cancer_type'))

last <- rbind(mutation_breast, mutation_ovary)  

last <- last %>% 
  mutate_if(is.character, as.factor) %>% 
  drop_na()

remove(breast, ovary, donor_breast, donor_ovary, mutation, mutation_breast, mutation_ovary, patient)

write.csv(last, file = "AfterPreparingData/mutation.csv")

remove(last)


```

##Selection of the most common mutations

```{r}


mutation_long_data <- read.csv("AfterPreparingData/mutation.csv", 
                               stringsAsFactors = T, header = T)

mutation_long_data <- mutation_long_data[,-1]


summary(mutation_long_data)

mutation_long_data <- mutation_long_data %>% 
  filter(icgc_mutation_id %in% c('MU4468','MU5219', 'MU7870', 'MU24637','MU4807', 'MU17943') ) %>% 
  distinct()

mutation_long_data <- mutation_long_data %>% 
  select(icgc_mutation_id, donor_vital_status, donor_age_at_diagnosis, cancer_type) %>% 
  drop_na() %>% 
  distinct()

```

#Binary notation for mutations

```{r}

mutation_long_data <- mutation_long_data %>% 
  mutate(values = "1")


mutation_wide_data <- pivot_wider(mutation_long_data, names_from = icgc_mutation_id, values_from = values , values_fill = "0")

remove(mutation_long_data)

write.csv(mutation_wide_data, file = "AfterPreparingData/mutation_wide_data")
```

###Models - machine learning

#Requirements 2

```{r}
library(rpart)
library(rpart.plot)
library(caret)
library(e1071)
library(cluster)
library(factoextra)
library(ClusterR)
library(corrplot)
```
##Hierarchic tree

```{r}
mutation_wide_data <- read.csv("AfterPreparingData/mutation_wide_data", header = T, stringsAsFactors = T)

mutation_wide_data <- mutation_wide_data[,-1]

tree_1 <- rpart(formula = donor_vital_status ~  ., data = mutation_wide_data)

rpart.plot(tree_1)

png(filename = "Figures/tree.png", units="px", width=2000, height=1600, res=300)


dev.off()

```

#Confusion matrix

```{r}

pred_risk_tree <- predict(object = tree_1, newdata = mutation_wide_data, type = "class")

confusionMatrix(data = pred_risk_tree, reference = mutation_wide_data$donor_vital_status, positive = "alive", mode = "everything")

```

##Training/Validation data dividing

```{r}

i <- i %>% 
  mutate_if(is.character, as.factor) 

split <- createDataPartition(y = mutation_wide_data$donor_vital_status, p = 0.8)


train_cancer <- mutation_wide_data[split$Resample1,]
valid_cancer <- mutation_wide_data[-split$Resample1,]

tree_1 <- rpart(formula = donor_vital_status ~  ., data = mutation_wide_data)


pred_risk_train <- predict(object = tree_1, newdata = train_cancer, type = "class")

pred_risk_valid <- predict(object = tree_1,newdata = valid_cancer, type = "class")

```
#Training_data_confusion_matrix

```{r}

confusionMatrix(data = pred_risk_train, reference = train_cancer$donor_vital_status, positive = "alive", mode = "everything")

```

#Validation_data_confusion_matrix

```{r}

confusionMatrix(data = pred_risk_valid, reference = valid_cancer$donor_vital_status,positive = "alive", mode = "everything")
```
##Multiple Linear Regression (MLR) - checking the significance of the mutation

```{r}

MLR_data <- read.csv('AfterPreparingData/mutation_wide_data', header = T, stringsAsFactors = T)

MLR_data <- MLR_data[,-1]

MLR_data <- MLR_data %>% 
  select(-cancer_type, -donor_age_at_diagnosis) 


MLR_data$donor_vital_status <- as.numeric(MLR_data$donor_vital_status)



MLR_model <- lm(formula = donor_vital_status ~ ., data = MLR_data)

summary(MLR_model)


```
##Corplot

```{r}

MLR_data <- MLR_data %>% 
cor()

corrplot(MLR_data, method = "color")
```



##K-mean

```{r}


KM_data <- read.csv('AfterPreparingData/mutation_wide_data', header = T, stringsAsFactors = T)

KM_data <- KM_data[,-1]

KM_data <- KM_data %>% 
  select(-cancer_type, -donor_age_at_diagnosis) 


KM_data$donor_vital_status <- as.numeric(KM_data$donor_vital_status)

KM_data <- KM_data %>% 
  scale()

Optimal_Clusters_KMeans(data = KM_data, max_clusters = 15, criterion = "WCSSE")


k_mean <- kmeans(KM_data, centers = 7, nstart = 25)


fviz_cluster(k_mean, data = KM_data, geom = 'text')


```


