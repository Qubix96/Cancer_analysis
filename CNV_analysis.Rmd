---
title: "CNV_analysis"
author: "Jakub Kubi≈õ"
date: "24 08 2020"
output: html_document
---

###Data preparing
# Requirements 1
```{r echo=TRUE}
library(tidyverse)
```

##Data joining
#Breast and ovarian data

```{r}

breast_cnv <- read.csv("DataBreast/copy_number_somatic_mutation.tsv.gz", sep = '\t', header = TRUE)
breast_cnv <- breast_cnv %>% 
  select(chromosome,
         chromosome_start,
         chromosome_end, 
         segment_mean,
         icgc_donor_id) 
  
breast_cnv$cnv_location <- paste0('chromosome: ',
                                  breast_cnv$chromosome,' : ',
                                  breast_cnv$chromosome_start, ' - ',
                                  breast_cnv$chromosome_end)


ovary_cnv <- read.csv("DataOvary/copy_number_somatic_mutation.tsv.gz", sep = '\t', header = TRUE)
ovary_cnv <- ovary_cnv %>% 
  select(chromosome,
         chromosome_start,
         chromosome_end, 
         segment_mean,
         icgc_donor_id)
  
ovary_cnv$cnv_location <- paste0('chromosome: ',
                                  ovary_cnv$chromosome,' : ',
                                  ovary_cnv$chromosome_start, ' - ',
                                  ovary_cnv$chromosome_end)

ovary_cnv$cancer_type <- "Ovarian cancer"
breast_cnv$cancer_type <- "Breast cancer"

patient <- breast_cnv %>% 
  inner_join(ovary_cnv, by = 'cnv_location') %>% 
  distinct()

patient <- patient %>% 
  select(cnv_location) %>% 
  distinct()

mutation_cnv <- rbind(breast_cnv, ovary_cnv)

mutation_cnv <- mutation_cnv %>% 
  filter(cnv_location %in% patient$cnv_location)
         

remove(breast_cnv, ovary_cnv, patient)


```

#Donor data

```{r}

donor_breast <- read.csv("DataBreast/donor.tsv", sep = '\t', header = TRUE)

donor_breast <- donor_breast %>% 
  select(icgc_donor_id,
         donor_vital_status, 
         disease_status_last_followup,
         donor_age_at_diagnosis,
         donor_age_at_last_followup,
         donor_sex) %>%
  filter(donor_sex == 'female')

donor_breast$cancer_type <- "Breast cancer"

donor_ovary <- read.csv("DataOvary/donor.tsv", sep = '\t', header = TRUE)

donor_ovary <- donor_ovary %>% 
  select(icgc_donor_id,
         donor_vital_status, 
         disease_status_last_followup,
         donor_age_at_diagnosis,
         donor_age_at_last_followup,
         donor_sex) %>%
  filter(donor_sex == 'female')

donor_ovary$cancer_type <- 'Ovarian cancer'
```

#Join donor - mutation

```{r}


mutation_breast_cnv <- mutation_cnv %>% 
  left_join(donor_breast, by = c('icgc_donor_id', 'cancer_type')) 

mutation_ovary_cnv <- mutation_cnv %>% 
  left_join(donor_ovary, by = c('icgc_donor_id', 'cancer_type'))

last <- rbind(mutation_breast_cnv, mutation_ovary_cnv)  

last <- last %>% 
  mutate_if(is.character, as.factor) %>% 
  drop_na() 
  

remove(breast, ovary, donor_breast, donor_ovary, mutation_cnv, mutation_breast_cnv, mutation_ovary_cnv, patient)

write.csv(last, file = "AfterPreparingData/CNV_prepared.csv")

remove(last)


```

##Selection of the most common mutations

```{r}



mutation_CNV_long_data <- read.csv("AfterPreparingData/CNV_prepared.csv", 
                               stringsAsFactors = T, header = T, row.names = 1)


mutation_CNV_long_data <- mutation_CNV_long_data %>% 
  select(donor_age_at_diagnosis, cnv_location, cancer_type, donor_vital_status) %>% 
  distinct()


mutation_CNV_long_data <- mutation_CNV_long_data %>% 
  group_by(cnv_location) %>% 
  mutate(n = n())

mutation_CNV_long_data <-mutation_CNV_long_data %>% 
  filter(n > 175)


summary(mutation_CNV_long_data)


mutation_CNV_long_data <- mutation_CNV_long_data %>% 
  mutate(values = "1")


mutation_CNV_wide_data <- pivot_wider(mutation_CNV_long_data, names_from = cnv_location, values_from = values, values_fill = "0")

remove(mutation_CNV_long_data)

write.csv(mutation_CNV_wide_data, file = "AfterPreparingData/mutation_CNV_wide_data")
```



###Models - machine learning

#Requirements 2

```{r}
library(tidyverse)
library(rpart)
library(rpart.plot)
library(caret)
library(e1071)
library(cluster)
library(factoextra)
library(ClusterR)
library(corrplot)
```
##Hierarchic tree

```{r}

mutation_CNV_wide_data <- read.csv("AfterPreparingData/mutation_CNV_wide_data", header = T, stringsAsFactors = T, row.names = 1)

mutation_CNV_wide_data <- mutation_CNV_wide_data %>% 
  select(-n) %>% 
  distinct() %>% 
  drop_na()


tree_1 <- rpart(formula = donor_vital_status ~  ., data = mutation_CNV_wide_data)

rpart.plot(tree_1)

png(filename = "Figures/tree_CNV.png", units="px", width=2000, height=1600, res=300)


dev.off()

```

#Confusion matrix

```{r}

pred_risk_tree <- predict(object = tree_1, newdata = mutation_CNV_wide_data, type = "class")

confusionMatrix(data = pred_risk_tree, reference = mutation_CNV_wide_data$donor_vital_status, positive = "alive", mode = "everything")

```

##Training/Validation data dividing

```{r}


split <- createDataPartition(y = mutation_CNV_wide_data$donor_vital_status, p = 0.8)


train_cancer <- mutation_CNV_wide_data[split$Resample1,]
valid_cancer <- mutation_CNV_wide_data[-split$Resample1,]

tree_1 <- rpart(formula = donor_vital_status ~  ., data = mutation_CNV_wide_data)


pred_risk_train <- predict(object = tree_1, newdata = train_cancer, type = "class")

pred_risk_valid <- predict(object = tree_1,newdata = valid_cancer, type = "class")

```
#Training_data_confusion_matrix

```{r}

confusionMatrix(data = pred_risk_train, reference = train_cancer$donor_vital_status, positive = "alive", mode = "everything")

```

#Validation_data_confusion_matrix

```{r}

confusionMatrix(data = pred_risk_valid, reference = valid_cancer$donor_vital_status,positive = "alive", mode = "everything")
```
##Multiple Linear Regression (MLR) - checking the significance of the mutation

```{r}

MLR_data <- read.csv('AfterPreparingData/mutation_CNV_wide_data', header = T, stringsAsFactors = T , row.names = 1)


MLR_data <- MLR_data %>% 
  select(-cancer_type, -donor_age_at_diagnosis, -n) 

MLR_data$donor_vital_status <- as.character(MLR_data$donor_vital_status)
MLR_data$donor_vital_status[MLR_data$donor_vital_status == 'alive'] <- "1"
MLR_data$donor_vital_status[MLR_data$donor_vital_status == 'deceased'] <- "0"
MLR_data$donor_vital_status <- as.numeric(MLR_data$donor_vital_status)



MLR_model <- glm(formula = donor_vital_status ~ ., data = MLR_data, family = 'binomial')

summary(MLR_model)


```
##Corplot

```{r}


MLR_data <- MLR_data %>% 
cor(method = "spearman")

corrplot(MLR_data, method = "color")
```



##K-mean


```{r}

KM_data <- read.csv('AfterPreparingData/mutation_wide_data', header = T, stringsAsFactors = T, row.names = 1)


KM_data <- KM_data %>% 
  select(-cancer_type, -donor_age_at_diagnosis) 


KM_data$donor_vital_status <- as.numeric(KM_data$donor_vital_status)

KM_data <- KM_data %>% 
  scale()

Optimal_Clusters_KMeans(data = KM_data, max_clusters = 15, criterion = "WCSSE")


k_mean <- eclust(KM_data, "kmeans", nstart = 25, k = 7)


fviz_cluster(k_mean, data = KM_data, geom = 'point', ggtheme = theme_grey())


png(filename = "Figures/clustering.png", units="px", width=2000, height=1600, res=300)


dev.off()

```

##Cluster - binary data


```{r}

bin_data <- read.csv('AfterPreparingData/mutation_wide_data', header = T, stringsAsFactors = T, row.names = 1)


bin_data <- bin_data %>% 
  select(-cancer_type, -donor_age_at_diagnosis) 

bin_matrix <- data.matrix(bin_data[,-1])
rownames(bin_matrix) <- bin_data$donor_vital_status



library(blockcluster)

data("binarydata")

coclust <- coclusterBinary(bin_matrix, nbcocluster=c(1,2))

summary(coclust)

plot(coclust)

```

